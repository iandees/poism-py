{% extends "_template.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
<script type="text/javascript">
    var tags_elem, empty_elem;
    document.addEventListener("DOMContentLoaded", function() {
        empty_elem = document.getElementById('empty-row').cloneNode(true);
        tags_elem = document.getElementById('tags');
    });

    function addRow() {
        var new_row_elem = empty_elem.cloneNode(true);
        new_row_elem.removeAttribute('id');
        tags_elem.appendChild(new_row_elem);
        return false;
    }

    let params = new URLSearchParams(location.search);
    var map;
    var marker;
    var gpsCircle;

    document.addEventListener("DOMContentLoaded", function() {
        map = new L.Map('map');

        var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib = 'Map data © <a href="https://www.openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, {
            minZoom: 8,
            maxZoom: 19,
            attribution: osmAttrib
        }).addTo(map);

        var mbUrl = 'https://{s}.tiles.mapbox.com/styles/v1/openstreetmap/cj8gojt0i1eau2rnn7q4mdgu7/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib3BlbnN0cmVldG1hcCIsImEiOiJhNVlHd29ZIn0.ti6wATGDWOmCnCYen-Ip7Q';
        var mbSat = new L.TileLayer(mbUrl, {
            minZoom: 8,
            maxZoom: 22,
            attribution: 'Imagery © <a href="http://www.mapbox.com/about/maps/">Mapbox</a>'
        });

        var baseMaps = {
            "OSM": osm,
            "Satellite": mbSat,
        }
        L.control.layers(baseMaps).addTo(map);

        map.setView([params.get('lat'), params.get('lon')], 17);

        marker = L.marker([params.get('lat'), params.get('lon')], {draggable: true, riseOnHover: true}).addTo(map);
        marker.on('moveend', function(e) {
            var ll = marker.getLatLng();
            console.log("Moved marker to " + ll.lat.toFixed(6) + "," + ll.lng.toFixed(6));
            document.getElementById('lat-form').value = ll.lat;
            document.getElementById('lon-form').value = ll.lng;
        });

        map.locate({enableHighAccuracy: true, watch: true, maxZoom: 18});
        function onLocationFound(e) {
            var radius = e.accuracy / 2;
            if (!gpsCircle) {
                gpsCircle = L.circle(e.latlng, radius).addTo(map);
            } else {
                gpsCircle.setLatLng(e.latlng);
            }
        }
        map.on('locationfound', onLocationFound);
    });
</script>
{% endblock %}

{% block container %}
{{super()}}

<p><a href="{{ url_for('nearby', lat=request.args.get('lat'), lon=request.args.get('lon')) }}">← Back to nearby places</a></p>

<div id="map" class="col-xs-12" style="height: 380px; margin-bottom: 20px;"></div>

<form method="post">
    <input type="hidden" name="lat" id="lat-form" />
    <input type="hidden" name="lon" id="lon-form" />
    <div id="tags">
        <div class="row" id="empty-row">
            <div class="col-xs-6">
                <input type="text" class="form-control" name="keys" autocapitalize="none" placeholder="Key">
            </div>
            <div class="col-xs-6">
                <input type="text" class="form-control" name="values" placeholder="Value">
            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-default">Save</button>
    <a class="btn btn-default" onclick="return addRow()">+ Row</a>
</form>

{% endblock %}
