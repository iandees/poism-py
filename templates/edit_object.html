{% extends "_template.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin=""/>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
<script src="https://unpkg.com/leaflet-ajax@2.1.0/dist/leaflet.ajax.min.js"
    integrity="sha384-sKs8ZrrxyJoElcPVznZwGpUTTXvkMYfHYxdIFzO8Hd0TA6emONMj8BwnsFf+6cZ/"
    crossorigin=""></script>
<script type="text/javascript">
    var tags_elem, empty_elem;
    document.addEventListener("DOMContentLoaded", function(){
        empty_elem = document.getElementById('empty-row').cloneNode(true);
        tags_elem = document.getElementById('tags');
    });

    function addRow() {
        var new_row_elem = empty_elem.cloneNode(true);
        new_row_elem.removeAttribute('id');
        tags_elem.appendChild(new_row_elem);
        return false;
    }

    var map;
    var gpsCircle;

    document.addEventListener("DOMContentLoaded", function() {
        map = new L.Map('map');

        var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib = 'Map data © <a href="https://www.openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, {
            minZoom: 8,
            maxZoom: 19,
            attribution: osmAttrib
        }).addTo(map);

        var mbUrl = 'https://{s}.tiles.mapbox.com/styles/v1/openstreetmap/cj8gojt0i1eau2rnn7q4mdgu7/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib3BlbnN0cmVldG1hcCIsImEiOiJhNVlHd29ZIn0.ti6wATGDWOmCnCYen-Ip7Q';
        var mbSat = new L.TileLayer(mbUrl, {
            minZoom: 8,
            maxZoom: 22,
            attribution: 'Imagery © <a href="http://www.mapbox.com/about/maps/">Mapbox</a>'
        });

        var baseMaps = {
            "OSM": osm,
            "Satellite": mbSat,
        }
        L.control.layers(baseMaps).addTo(map);

        geojsonLayer = new L.GeoJSON.AJAX("{{ url_for('object_as_geojson', obj_type=obj['type'], obj_id=obj['id']) }}");
        geojsonLayer.addTo(map);
        geojsonLayer.on('data:loaded', function(e) {
            map.fitBounds(geojsonLayer.getBounds());
        });

        map.locate({enableHighAccuracy: true, watch: true, maxZoom: 18});
        function onLocationFound(e) {
            var radius = e.accuracy / 2;
            if (!gpsCircle) {
                gpsCircle = L.circle(e.latlng, radius).addTo(map);
            } else {
                gpsCircle.setLatLng(e.latlng);
            }
        }
        map.on('locationfound', onLocationFound);
    });
</script>
{% endblock %}

{% block container %}
{{super()}}

<p><a href="{{ url_for('nearby', lat=request.args.get('lat'), lon=request.args.get('lon')) }}">← Back to nearby places</a></p>

<div id="map" class="col-xs-12" style="height: 380px; margin-bottom: 20px;"></div>

<form method="post">
    <input type="hidden" name="version" value="{{ obj['version'] }}"/>
    <div id="tags">
        {% for k, v in obj['tags'].items() %}
        <div class="row">
            <div class="col-xs-6">
                <input type="text" class="form-control" name="keys" value="{{ k }}">
            </div>
            <div class="col-xs-6">
                <input type="text" class="form-control" name="values" value="{{ v }}">
            </div>
        </div>
        {% endfor %}
        <div class="row" id="empty-row">
            <div class="col-xs-6">
                <input type="text" class="form-control" name="keys" placeholder="Key">
            </div>
            <div class="col-xs-6">
                <input type="text" class="form-control" name="values" placeholder="Value">
            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-default">Save</button>
    <a class="btn btn-default" onclick="return addRow()">+ Row</a>
</form>

{% endblock %}
