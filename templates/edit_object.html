{% extends "_template.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
    integrity="sha384-eS4bw6aEvhCSXWGP85ANR/N8isWKzT7P36NvcuTJGkrj6wsbxLVpXslrNXYHyseD"
    crossorigin=""/>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
    integrity="sha384-bmPowDlt+owc6Mn3LwOzLPkYiVm6MuKeLMe0qN2pp7Fhmux2xtVJm5e+ekpCVv4x"
    crossorigin=""></script>
<script src="https://unpkg.com/leaflet-ajax@2.1.0/dist/leaflet.ajax.min.js"
    integrity="sha384-sKs8ZrrxyJoElcPVznZwGpUTTXvkMYfHYxdIFzO8Hd0TA6emONMj8BwnsFf+6cZ/"
    crossorigin=""></script>
<script type="text/javascript">
    var map;
    var gpsCircle;

    document.addEventListener("DOMContentLoaded", function() {
        map = new L.Map('map');

        var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib = 'Map data © <a href="https://www.openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, {
            minZoom: 8,
            maxZoom: 19,
            attribution: osmAttrib
        }).addTo(map);

        var mbUrl = 'https://{switch:a,b,c,d}.tiles.mapbox.com/v4/mapbox.satellite/{zoom}/{x}/{y}.jpg?access_token=pk.eyJ1Ijoib3BlbnN0cmVldG1hcCIsImEiOiJjaml5MjVyb3MwMWV0M3hxYmUzdGdwbzE4In0.q548FjhsSJzvXsGlPsFxAQ';
        var mbSat = new L.TileLayer(mbUrl, {
            minZoom: 8,
            maxZoom: 22,
            attribution: 'Imagery © <a href="http://www.mapbox.com/about/maps/">Mapbox</a>'
        });

        var baseMaps = {
            "OSM": osm,
            "Satellite": mbSat,
        }
        L.control.layers(baseMaps).addTo(map);

        var geojsonLayer = new L.GeoJSON.AJAX("{{ url_for('object_as_geojson', obj_type=obj['type'], obj_id=obj['id']) }}");
        geojsonLayer.on('data:loaded', function(e) {
            geojsonLayer.addTo(map);
            map.fitBounds(geojsonLayer.getBounds());
        });

        map.locate({enableHighAccuracy: true, watch: true, maxZoom: 18});
        map.on('locationfound', function(e) {
            var radius = e.accuracy / 2;
            if (!gpsCircle) {
                gpsCircle = L.circle(e.latlng, radius).addTo(map);
            } else {
                gpsCircle.setLatLng(e.latlng);
                gpsCircle.setRadius(radius);
            }
        });
    });
</script>
{% endblock %}

{% block container %}
{{super()}}

<p><a href="{{ url_for('nearby', lat=request.args.get('lat'), lon=request.args.get('lon')) }}">← Back to nearby places</a></p>

<div id="map" class="col-xs-12" style="height: 380px; margin-bottom: 20px;"></div>

<h3>
    {% if preset.icon.startswith('maki-') %}
    <img width="40" src="https://cdn.jsdelivr.net/gh/mapbox/maki/icons/{{ preset.icon[5:] }}-15.svg"/>
    {% elif preset.icon.startswith('fas-') %}
    <img width="40" src="https://cdn.jsdelivr.net/gh/openstreetmap/iD@master/svg/fontawesome/{{ preset.icon }}.svg"/>
    {% elif preset.icon.startswith('temaki-') %}
    <img width="40" src="https://cdn.jsdelivr.net/gh/bhousel/temaki/icons/{{ preset.icon[7:] }}.svg"/>
    {% endif %}
    {{ preset.name }}
</h3>

<form method="post">
    {{ form.hidden_tag() }}

    {% if 'name' in fields %}
    <div class="form-group">
        <label for="name">Name</label>
        {{ form.name(class_="form-control") }}
    </div>
    {% endif %}

    {% if 'phone' in fields %}
    <div class="form-group">
        <label for="name">Phone</label>
        {{ form.phone(type="tel", class_="form-control") }}
    </div>
    {% endif %}

    {% if 'address' in fields %}
    <legend>Address Details</legend>

    <div class="row">
        <div class="form-group col-xs-3">
            <label for="addr_housenumber">Housenumber</label>
            {{ form.addr_housenumber(class_="form-control") }}
        </div>
        <div class="form-group col-xs-9">
            <label for="addr_street">Street</label>
            {{ form.addr_street(class_="form-control") }}
        </div>
    </div>

    <div class="row">
        <div class="form-group col-xs-6">
            <label for="addr_city">City</label>
            {{ form.addr_city(class_="form-control") }}
        </div>
        <div class="form-group col-xs-3">
            <label for="addr_state">State</label>
            {{ form.addr_state(class_="form-control") }}
        </div>
        <div class="form-group col-xs-3">
            <label for="addr_postcode">Zipcode</label>
            {{ form.addr_postcode(class_="form-control") }}
        </div>
    </div>
    {% endif %}

    {% if 'opening_hours' in fields %}
    <legend>Opening Hours</legend>

    <div class="row">
        <div class="form-group col-xs-12">
            {{ form.opening_hours_complex(class_="form-control") }}
        </div>
    </div>
    {% endif %}

    {{ form.submit(class_="btn btn-default") }}
</form>

{% endblock %}
